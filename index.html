<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wackachat</title>
  <style>
    body {
      font-family: 'SF Pro Display', sans-serif;
      background: #000;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      flex-direction: column;
      gap: 1rem;
    }
    video {
      width: 300px;
      border-radius: 10px;
      margin: 0 10px;
      border: 1px solid #444;
    }
    .button {
      padding: 0.8rem 1.5rem;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .button:hover {
      background: #0056b3;
    }
  </style>
</head>
<body>

  <h1>Wackachat ðŸŽ¥</h1>
  <div>
    <video id="my-video" autoplay muted playsinline></video>
    <video id="user-video" autoplay playsinline></video>
  </div>
  <button class="button" onclick="callRandomPeer()">Call Now</button>

  <!-- Firebase v8 SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

  <!-- PeerJS - WORKING CDN -->
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBHz_pnME24A3YalXA8OqlfJXY_fKCSpNk",
      authDomain: "wackachat.firebaseapp.com",
      databaseURL: "https://wackachat-default-rtdb.firebaseio.com",
      projectId: "wackachat",
      storageBucket: "wackachat.appspot.com",
      messagingSenderId: "344884471257",
      appId: "1:344884471257:web:3d8dfb005128735ae7a5c8"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const myVideo = document.getElementById('my-video');
    const userVideo = document.getElementById('user-video');

    let localStream;
    let peer = null;

    // Setup media and Peer connection
    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      .then(stream => {
        localStream = stream;
        myVideo.srcObject = stream;

        peer = new Peer(); // Auto-generates ID

        peer.on('open', id => {
          console.log("My Peer ID: " + id);

          // Listen for incoming calls
          peer.on('call', call => {
            call.answer(localStream);
            call.on('stream', userStream => {
              userVideo.srcObject = userStream;
            });
          });
        });

      })
      .catch(error => {
        console.error('Media error:', error);
        alert('Camera/Mic access failed. Please allow and reload.');
      });

    // Global call function
    function callRandomPeer() {
      if (!peer || !peer.id) {
        alert("Peer connection not ready yet. Please wait...");
        return;
      }

      const waitingRef = db.ref('waiting');
      const myID = peer.id;

      waitingRef.once('value', snapshot => {
        const peers = snapshot.val() || {};
        const availablePeers = Object.keys(peers).filter(id => id !== myID);

        if (availablePeers.length > 0) {
          const randomPeerID = availablePeers[Math.floor(Math.random() * availablePeers.length)];
          console.log("Calling: " + randomPeerID);
          const call = peer.call(randomPeerID, localStream);

          call.on('stream', userStream => {
            userVideo.srcObject = userStream;
          });

          db.ref('waiting/' + randomPeerID).remove();
        } else {
          waitingRef.child(myID).set({ timestamp: Date.now() });
          alert("No peers available. You're now waiting to be called.");
        }
      });
    }
  </script>
</body>
</html>
