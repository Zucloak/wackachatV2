
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WackaChat</title>
  <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
    video { width: 300px; height: 225px; margin: 10px; background: #000; }
    #messages { border: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: scroll; text-align: left; margin-top: 20px; }
    #chatInput { width: 80%; padding: 10px; margin-top: 10px; }
  </style>
</head>
<body>

  <h1>WackaChat</h1>

  <h3>Random Video Call</h3>
  <button onclick="callRandomPeer()">Call Now</button>
  <div>
    <video id="myVideo" autoplay muted></video>
    <video id="peerVideo" autoplay></video>
  </div>

  <h3>Random Text Chat</h3>
  <button onclick="startTextChat()">Chat Now</button>
  <div id="messages"></div>
  <input id="chatInput" type="text" placeholder="Type your message..." />
  <button onclick="sendMessage()">Send</button>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBHz_pnME24A3YalXA8OqlfJXY_fKCSpNk",
      authDomain: "wackachat.firebaseapp.com",
      databaseURL: "https://wackachat-default-rtdb.firebaseio.com",
      projectId: "wackachat",
      storageBucket: "wackachat.appspot.com",
      messagingSenderId: "344884471257",
      appId: "1:344884471257:web:3d8dfb005128735ae7a5c8",
      measurementId: "G-MZM4LSXWFG"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- Random Video Call ---
    const peer = new Peer();
    let localStream;
    navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
      document.getElementById("myVideo").srcObject = stream;
      localStream = stream;
    });

    peer.on("open", id => {
      console.log("My Peer ID: " + id);
      db.ref("waitingCalls").once("value").then(snapshot => {
        const waitingPeer = snapshot.val();
        if (waitingPeer) {
          db.ref("waitingCalls").remove();
          const call = peer.call(waitingPeer, localStream);
          call.on("stream", remoteStream => {
            document.getElementById("peerVideo").srcObject = remoteStream;
          });
        } else {
          db.ref("waitingCalls").set(id);
        }
      });
    });

    peer.on("call", call => {
      call.answer(localStream);
      call.on("stream", remoteStream => {
        document.getElementById("peerVideo").srcObject = remoteStream;
      });
    });

    function callRandomPeer() {
      window.location.reload(); // triggers a new peer ID to be generated
    }

    // --- Random Text Chat ---
    let currentRoom = null;
    let userId = Math.random().toString(36).substring(2, 10);

    function startTextChat() {
      db.ref("waitingTextUsers").once("value").then(snapshot => {
        const partnerId = snapshot.val();
        if (partnerId && partnerId !== userId) {
          db.ref("waitingTextUsers").remove();
          const roomId = userId + partnerId;
          currentRoom = roomId;
          db.ref("textRooms/" + roomId).push({ sender: "System", text: "User connected." });
          listenForMessages(roomId);
        } else {
          db.ref("waitingTextUsers").set(userId);
        }
      });
    }

    function listenForMessages(roomId) {
      db.ref("textRooms/" + roomId).on("child_added", snapshot => {
        const msg = snapshot.val();
        const messageDiv = document.getElementById("messages");
        messageDiv.innerHTML += `<p><strong>${msg.sender}:</strong> ${msg.text}</p>`;
        messageDiv.scrollTop = messageDiv.scrollHeight;
      });
    }

    function sendMessage() {
      const msgText = document.getElementById("chatInput").value;
      if (!currentRoom || msgText.trim() === "") return;
      db.ref("textRooms/" + currentRoom).push({ sender: userId, text: msgText });
      document.getElementById("chatInput").value = "";
    }
  </script>
</body>
</html>
